<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APS - Design Automation for Dynamo</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <link rel="stylesheet" href="/css/styles.css">
</head>

<body>
    <div class="container-fluid">
        <div class="header">
            <img src="https://cdn.autodesk.io/logo/black/stacked.png" alt="Autodesk Platform Services" height="50">
            <h1>Design Automation for Dynamo</h1>
        </div>

        <div class="row">
            <div class="col-sm-4">
                <!-- Cleanup -->
                <div class="step-box">
                    <h5>0. Cleanup First</h5>
                    <p><strong>Start fresh by deleting any existing resources.</strong> This prevents conflicts and ensures a clean setup.</p>
                    <div class="row mb-2">
                        <div class="col-8">
                            <button id="btnClearDA" class="btn btn-danger w-100">Clear DA Resources</button>
                        </div>
                        <div class="col-4">
                            <button onclick="viewSourceCode('0.1_clear_da_resources.js')" class="btn btn-outline-secondary btn-sm w-100">üìÑ See Code</button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-8">
                            <button id="btnClearBucket" class="btn btn-danger w-100">Clear OSS Bucket</button>
                        </div>
                        <div class="col-4">
                            <button onclick="viewSourceCode('0.2_clear_oss_bucket.js')" class="btn btn-outline-secondary btn-sm w-100">üìÑ See Code</button>
                        </div>
                    </div>
                </div>

                <!-- Setup -->
                <div class="step-box">
                    <h5>1. Setup</h5>
                    <p><strong>Authenticate and create the required APS resources.</strong> Each sub-step builds on the previous one.</p>
                    
                    <div class="card mb-2">
                        <div class="card-body">
                            <h6>1. Get Access Token</h6>
                            <p class="small text-muted mb-2">Authenticates with APS using your Client ID and Secret.</p>
                            <div class="row">
                                <div class="col-8">
                                    <button id="btnGetToken" class="btn btn-secondary w-100">Get Access Token</button>
                                </div>
                                <div class="col-4">
                                    <button onclick="viewSourceCode('1.1_get_access_token.js')" class="btn btn-outline-secondary btn-sm w-100">üìÑ See Code</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-2">
                        <div class="card-body">
                            <h6>2. Get Nickname</h6>
                            <p class="small text-muted mb-2">Checks if you already have a Design Automation nickname assigned.</p>
                            <div class="row">
                                <div class="col-8">
                                    <button id="btnGetNickname" class="btn btn-info w-100">Get Nickname</button>
                                </div>
                                <div class="col-4">
                                    <button onclick="viewSourceCode('1.2_get_nickname.js')" class="btn btn-outline-secondary btn-sm w-100">üìÑ See Code</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-2">
                        <div class="card-body">
                            <h6>3. Set Nickname</h6>
                            <p class="small text-muted mb-2">Creates a unique nickname for your DA app.</p>
                            <div class="row">
                                <div class="col-8">
                                    <button id="btnSetNickname" class="btn btn-secondary w-100">Set Nickname</button>
                                </div>
                                <div class="col-4">
                                    <button onclick="viewSourceCode('1.3_set_nickname.js')" class="btn btn-outline-secondary btn-sm w-100">üìÑ See Code</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-2">
                        <div class="card-body">
                            <h6>4. AppBundle File (.zip)</h6>
                            <p class="small text-muted mb-2">Select the DynamoRevitDA.zip file containing the Dynamo engine and upload it.</p>
                            <div class="mb-2">
                                <input class="form-control" type="file" id="appBundleFile" accept=".zip">
                            </div>
                            <small class="text-warning mb-2 d-block">üìÅ <strong>File needed:</strong> DynamoRevitDA.zip</small>
                            <div class="row">
                                <div class="col-8">
                                    <button id="btnUploadAppBundle" class="btn btn-secondary w-100">Create/Update AppBundle</button>
                                </div>
                                <div class="col-4">
                                    <button onclick="viewSourceCode('1.5_upload_appbundle.js')" class="btn btn-outline-secondary btn-sm w-100">üìÑ See Code</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-2">
                        <div class="card-body">
                            <h6>5. Create Activity</h6>
                            <p class="small text-muted mb-2">Defines the workflow: how Dynamo processes your files.</p>
                            <div class="row">
                                <div class="col-8">
                                    <button id="btnCreateActivity" class="btn btn-secondary w-100">Create/Update Activity</button>
                                </div>
                                <div class="col-4">
                                    <button onclick="viewSourceCode('1.6_create_activity.js')" class="btn btn-outline-secondary btn-sm w-100">üìÑ See Code</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-2">
                        <div class="card-body">
                            <h6>6. Create OSS Bucket</h6>
                            <p class="small text-muted mb-2">Creates cloud storage for your files.</p>
                            <div class="row">
                                <div class="col-8">
                                    <button id="btnCreateBucket" class="btn btn-secondary w-100">Create OSS Bucket</button>
                                </div>
                                <div class="col-4">
                                    <button onclick="viewSourceCode('1.7_create_oss_bucket.js')" class="btn btn-outline-secondary btn-sm w-100">üìÑ See Code</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Files -->
                <div class="step-box">
                    <h5>2. Upload Files</h5>
                    <p><strong>Upload your files to the cloud storage.</strong> All files are required for processing.</p>

                    <div class="card mb-2">
                        <div class="card-body">
                            <h6>1. Python Dependencies</h6>
                            <p class="small text-muted mb-2">Upload the pythonDependencies.zip file.</p>
                            <div class="mb-2">
                                <input class="form-control" type="file" id="pythonFile" accept=".zip">
                            </div>
                            <small class="text-warning mb-2 d-block">üìÅ <strong>File needed:</strong> pythonDependencies.zip</small>
                            <div class="row">
                                <div class="col-8">
                                    <button id="btnUploadPython" class="btn btn-primary w-100">Upload Python Dependencies</button>
                                </div>
                                <div class="col-4">
                                    <button onclick="viewSourceCode('2.5_upload_python_dependencies.js')" class="btn btn-outline-secondary btn-sm w-100">üìÑ See Code</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-2">
                        <div class="card-body">
                            <h6>2. Revit File</h6>
                            <p class="small text-muted mb-2">Upload your Revit file (will be renamed to run.rvt).</p>
                            <div class="mb-2">
                                <input class="form-control" type="file" id="rvtFile" accept=".rvt">
                            </div>
                            <small class="text-warning mb-2 d-block">üìÅ <strong>File type:</strong> .rvt (Revit files)</small>
                            <div class="row">
                                <div class="col-8">
                                    <button id="btnUploadRvt" class="btn btn-primary w-100">Upload Revit File</button>
                                </div>
                                <div class="col-4">
                                    <button onclick="viewSourceCode('2.1_upload_revit_file.js')" class="btn btn-outline-secondary btn-sm w-100">üìÑ See Code</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-2">
                        <div class="card-body">
                            <h6>3. Dynamo Script</h6>
                            <p class="small text-muted mb-2">Upload your Dynamo script (will be renamed to run.dyn).</p>
                            <div class="mb-2">
                                <input class="form-control" type="file" id="dynFile" accept=".dyn">
                            </div>
                            <small class="text-warning mb-2 d-block">üìÅ <strong>File type:</strong> .dyn (Dynamo files)</small>
                            <div class="row">
                                <div class="col-8">
                                    <button id="btnUploadDyn" class="btn btn-primary w-100">Upload Dynamo Script</button>
                                </div>
                                <div class="col-4">
                                    <button onclick="viewSourceCode('2.2_upload_dynamo_file.js')" class="btn btn-outline-secondary btn-sm w-100">üìÑ See Code</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-2">
                        <div class="card-body">
                            <h6>4. JSON File (run.json)</h6>
                            <p class="small text-muted mb-2">Convert your .dyn file to JSON format (required by Design Automation), then upload it.</p>
                            <div class="mb-2">
                                <textarea class="form-control" id="jsonContent" rows="4" placeholder="JSON content will appear here after conversion..." readonly></textarea>
                            </div>
                            <div class="btn-group w-100 mb-2">
                                <button type="button" class="btn btn-warning btn-sm" id="btnConvertDynToJson">Convert Dynamo File (Step 3) to JSON</button>
                                <button type="button" class="btn btn-info btn-sm" id="btnUploadJson" disabled>Upload JSON to Bucket</button>
                            </div>
                            <small class="text-info mb-2 d-block"><strong>üîÑ Process:</strong> First convert, then upload the JSON version</small>
                        </div>
                    </div>

                    <div class="card mb-2">
                        <div class="card-body">
                            <h6>6. Packages (Optional)</h6>
                            <p class="small text-muted mb-2">Upload custom Dynamo packages if needed.</p>
                            <div class="mb-2">
                                <input class="form-control" type="file" id="packagesFile" accept=".zip">
                            </div>
                            <small class="text-info mb-2 d-block">üì¶ <strong>Optional:</strong> Custom packages.zip</small>
                            <div class="row">
                                <div class="col-8">
                                    <button id="btnUploadPackages" class="btn btn-info w-100">Upload Packages</button>
                                </div>
                                <div class="col-4">
                                    <button onclick="viewSourceCode('2.6_upload_packages.js')" class="btn btn-outline-secondary btn-sm w-100">üìÑ See Code</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Execute -->
                <div class="step-box">
                    <h5>3. Execute</h5>
                    <p><strong>Run your Dynamo script on the Revit file in the cloud.</strong></p>
                    <div class="row">
                        <div class="col-8">
                            <button id="btnRunWorkitem" class="btn btn-success w-100" style="font-size: 1.1rem; font-weight: bold;">‚ñ∂Ô∏è Run Workitem</button>
                        </div>
                        <div class="col-4">
                            <button onclick="viewSourceCode('3.1_run_workitem.js')" class="btn btn-outline-secondary btn-sm w-100">üìÑ See Code</button>
                        </div>
                    </div>
                </div>

                <!-- Download Results -->
                <div class="step-box">
                    <h5>4. Download Results</h5>
                    <p><strong>Download the processed files.</strong> Available after successful execution.</p>
                    
                    <div class="card mb-2">
                        <div class="card-body">
                            <h6>Result Report (JSON)</h6>
                            <p class="small text-muted mb-2">Contains text from Dynamo output node or nodes designated as "as output".</p>
                            <div class="row">
                                <div class="col-8">
                                    <button id="btnDownloadJson" class="btn btn-success w-100">Download Result JSON</button>
                                </div>
                                <div class="col-4">
                                    <button onclick="viewSourceCode('4.1_download_result_json.js')" class="btn btn-outline-secondary btn-sm w-100">üìÑ See Code</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-2">
                        <div class="card-body">
                            <h6>Result Revit File</h6>
                            <p class="small text-muted mb-2">Your modified Revit file with changes applied.</p>
                            <div class="row">
                                <div class="col-8">
                                    <button id="btnDownloadRvt" class="btn btn-success w-100">Download Result RVT</button>
                                </div>
                                <div class="col-4">
                                    <button onclick="viewSourceCode('4.2_download_result_rvt.js')" class="btn btn-outline-secondary btn-sm w-100">üìÑ See Code</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-sm-8">
                <div class="step-box">
                    <h5>üìä Output Log</h5>
                    <div id="outputLog" class="log-box">Ready to start! Click any button to begin...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Socket.IO setup for real-time updates
        let socket = io();
        let socketId = null;
        
        socket.on('connect', () => {
            appendToLog('Connected to server for real-time updates');
        });
        
        socket.on('socketId', (id) => {
            socketId = id;
            appendToLog(`Client registered with socket ID: ${socketId}`);
        });
        
        socket.on('status', (data) => {
            appendToLog(data.message);
        });
        
        socket.on('disconnect', () => {
            appendToLog('Disconnected from server');
        });

        // Get server URL dynamically (no hardcoded localhost:8080)
        function getServerUrl() {
            return window.location.origin;
        }

        // Enhanced function to view source code in new window
        function viewSourceCode(filename) {
            const serverUrl = getServerUrl();
            const codeWindow = window.open('', '_blank', 'width=1000,height=700,scrollbars=yes,resizable=yes');
            
            codeWindow.document.write(`
                <html>
                <head>
                    <title>Source Code: ${filename}</title>
                    <style>
                        body { font-family: 'Consolas', 'Monaco', 'Courier New', monospace; margin: 20px; background: #f8f9fa; }
                        .header { background: #007bff; color: white; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
                        .code-container { background: white; border: 1px solid #dee2e6; border-radius: 5px; padding: 20px; white-space: pre-wrap; line-height: 1.4; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>üìÑ Source Code: ${filename}</h2>
                        <p>Educational view of the complete implementation</p>
                    </div>
                    <div class="code-container">Loading...</div>
                </body>
                </html>
            `);

            fetch(`${serverUrl}/view-source/${filename}`)
                .then(response => response.text())
                .then(code => {
                    const codeContainer = codeWindow.document.querySelector('.code-container');
                    codeContainer.textContent = code;
                })
                .catch(error => {
                    const codeContainer = codeWindow.document.querySelector('.code-container');
                    codeContainer.textContent = `Error loading source code: ${error.message}`;
                });
        }

        // Utility function to append messages to the log
        function appendToLog(message) {
            const outputLog = document.getElementById('outputLog');
            const timestamp = new Date().toLocaleTimeString();
            outputLog.textContent += `[${timestamp}] ${message}\n`;
            outputLog.scrollTop = outputLog.scrollHeight;
        }

        // Generic function to make API calls
        async function makeApiCall(endpoint, method = 'GET', formData = null) {
            const serverUrl = getServerUrl();
            
            try {
                appendToLog(`Making ${method} request to ${endpoint}...`);
                
                const options = {
                    method: method,
                    headers: {}
                };
                
                if (formData) {
                    options.body = formData;
                } else if (method === 'POST') {
                    options.headers['Content-Type'] = 'application/json';
                    options.body = JSON.stringify({});
                }
                
                const response = await fetch(`${serverUrl}${endpoint}`, options);
                const data = await response.json();
                
                if (data.success || data.message) {
                    const message = data.message || data.operation;
                    appendToLog(`‚úÖ ${message}`);
                    if (data.details) {
                        if (typeof data.details === 'string') {
                            appendToLog(`   Details: ${data.details}`);
                        } else {
                            appendToLog(`   Details: ${JSON.stringify(data.details, null, 2)}`);
                        }
                    }
                } else {
                    const errorMsg = data.error || 'Unknown error';
                    appendToLog(`‚ùå ${errorMsg}`);
                    if (data.details) {
                        appendToLog(`   Error details: ${JSON.stringify(data.details, null, 2)}`);
                    }
                }
                
                return data;
            } catch (error) {
                appendToLog(`‚ùå Network error: ${error.message}`);
                return { success: false, error: error.message };
            }
        }

        // Function to make API calls with Socket.IO for real-time updates
        async function makeApiCallWithSocket(endpoint, method = 'GET', formData = null) {
            if (!socketId) {
                appendToLog('‚ùå Not connected to server. Please refresh the page.');
                return;
            }
            
            const serverUrl = getServerUrl();
            
            try {
                appendToLog(`Making ${method} request to ${endpoint}...`);
                
                const options = {
                    method: method,
                    headers: {}
                };
                
                if (formData) {
                    options.body = formData;
                } else {
                    options.headers['Content-Type'] = 'application/json';
                    options.body = JSON.stringify({ socketId: socketId });
                }
                
                const response = await fetch(`${serverUrl}${endpoint}`, options);
                const data = await response.json();
                
                // Don't log here - Socket.IO will handle real-time updates
                return data;
            } catch (error) {
                appendToLog(`‚ùå Network error: ${error.message}`);
                return { success: false, error: error.message };
            }
        }

        // Function specifically for JSON conversion that shows the JSON content
        async function makeApiCallWithConversion(endpoint, method = 'GET', formData = null) {
            if (!socketId) {
                appendToLog('‚ùå Not connected to server. Please refresh the page.');
                return;
            }
            
            const serverUrl = getServerUrl();
            
            try {
                appendToLog(`Making ${method} request to ${endpoint}...`);
                
                const options = {
                    method: method,
                    body: formData
                };
                
                const response = await fetch(`${serverUrl}${endpoint}`, options);
                const data = await response.json();
                
                if (response.ok && data.jsonContent) {
                    // Show JSON content in the textarea
                    const jsonTextarea = document.getElementById('jsonContent');
                    const uploadJsonBtn = document.getElementById('btnUploadJson');
                    
                    if (jsonTextarea) {
                        jsonTextarea.value = data.jsonContent;
                        appendToLog('‚úÖ JSON content generated and displayed in the text area');
                    }
                    
                    if (uploadJsonBtn) {
                        uploadJsonBtn.disabled = false;
                        appendToLog('‚úÖ Upload JSON button enabled - you can now upload the JSON');
                    }
                } else {
                    const errorMsg = data.error || 'Unknown error occurred';
                    appendToLog(`‚ùå ${errorMsg}`);
                    if (data.details) {
                        appendToLog(`   Details: ${data.details}`);
                    }
                }
                
                return data;
            } catch (error) {
                appendToLog(`‚ùå Network error: ${error.message}`);
                return { success: false, error: error.message };
            }
        }

        // Function to display Dynamo execution results (from reference implementation)
        function displayDynamoOutputs(resultData) {
            appendToLog(`<br/>--- DYNAMO EXECUTION RESULTS ---`);
            
            if (!resultData || !resultData.info) {
                appendToLog('‚ö†Ô∏è No execution info found in result.json');
                return;
            }
            
            const info = resultData.info;
            
            // Display execution status
            appendToLog(`<strong>üìä Status:</strong> ${info.status || 'Unknown'}`);
            
            // Display issues if any
            if (info.issues && info.issues.length > 0) {
                appendToLog(`<strong>‚ö†Ô∏è Issues:</strong>`);
                info.issues.forEach((issue, index) => {
                    appendToLog(`  ${index + 1}. ${issue}`);
                });
            } else {
                appendToLog(`<strong>‚úÖ Issues:</strong> None`);
            }
            
            // Display outputs
            if (info.outputs && info.outputs.length > 0) {
                appendToLog(`<br/><strong>üìà Captured Outputs:</strong>`);
                info.outputs.forEach((output, index) => {
                    appendToLog(`<br/><strong>üîó Output ${index + 1}: ${output.name}</strong>`);
                    appendToLog(`  üìù Type: ${output.type || 'Unknown'}`);
                    
                    if (output.value && Array.isArray(output.value)) {
                        const flatValues = output.value.flat();
                        appendToLog(`  üìä Values: ${flatValues.length} items`);
                        
                        // Show first few values as preview
                        if (flatValues.length > 0) {
                            const preview = flatValues.slice(0, 5);
                            appendToLog(`  üîç Preview: ${preview.join(', ')}${flatValues.length > 5 ? '...' : ''}`);
                        }
                    } else if (output.value !== null && output.value !== undefined) {
                        appendToLog(`  üìù Value: ${output.value}`);
                    } else {
                        appendToLog(`  üìù Value: (null/undefined)`);
                    }
                });
            } else {
                appendToLog(`<br/><strong>üìà Captured Outputs:</strong> None`);
            }
            
            // Display timing information if available
            if (info.executionTime) {
                appendToLog(`<br/><strong>‚è±Ô∏è Execution Time:</strong> ${info.executionTime}ms`);
            }
            
            appendToLog(`<br/>--- END DYNAMO RESULTS ---<br/>`);
        }

        // Event listeners for all buttons - Updated to match reference API paths
        document.getElementById('btnClearDA').addEventListener('click', () => makeApiCall('/api/aps/account', 'DELETE'));
        document.getElementById('btnClearBucket').addEventListener('click', () => makeApiCall('/api/aps/bucket', 'DELETE'));
        document.getElementById('btnGetToken').addEventListener('click', () => makeApiCall('/api/aps/token', 'POST'));
        document.getElementById('btnGetNickname').addEventListener('click', () => makeApiCall('/api/aps/nickname', 'GET'));
        document.getElementById('btnSetNickname').addEventListener('click', () => makeApiCall('/api/aps/nickname', 'POST'));
        document.getElementById('btnCreateActivity').addEventListener('click', () => makeApiCall('/api/aps/activity', 'POST'));
        document.getElementById('btnCreateBucket').addEventListener('click', () => makeApiCall('/api/aps/bucket', 'POST'));
        document.getElementById('btnConvertDynToJson').addEventListener('click', () => {
            const fileInput = document.getElementById('dynFile');
            if (!fileInput.files[0]) {
                appendToLog('‚ùå Please select a Dynamo (.dyn) file first');
                return;
            }
            if (!socketId) {
                appendToLog('‚ùå Not connected to server. Please refresh the page.');
                return;
            }
            const formData = new FormData();
            formData.append('dynFile', fileInput.files[0]);
            formData.append('socketId', socketId);
            formData.append('showContent', 'true');
            makeApiCallWithConversion('/api/aps/upload/dyn-to-json-preview', 'POST', formData);
        });
        document.getElementById('btnUploadJson').addEventListener('click', () => {
            const jsonTextarea = document.getElementById('jsonContent');
            if (!jsonTextarea.value.trim()) {
                appendToLog('‚ùå No JSON content to upload. Please convert a Dynamo file first.');
                return;
            }
            if (!socketId) {
                appendToLog('‚ùå Not connected to server. Please refresh the page.');
                return;
            }
            
            // Create a Blob from the JSON content
            const jsonBlob = new Blob([jsonTextarea.value.trim()], { type: 'application/json' });
            const jsonFile = new File([jsonBlob], 'run.json', { type: 'application/json' });
            
            const formData = new FormData();
            formData.append('file', jsonFile);
            formData.append('fileType', 'json');
            formData.append('socketId', socketId);
            
            makeApiCall('/api/aps/upload/single', 'POST', formData);
        });
        document.getElementById('btnRunWorkitem').addEventListener('click', () => {
            if (!socketId) {
                appendToLog('‚ùå Not connected to server. Please refresh the page.');
                return;
            }
            
            // Pass required parameters that the backend expects
            const requestBody = {
                socketId: socketId,
                rvtFileName: 'run.rvt',  // This matches the reference implementation
                hasPackages: false      // Optional parameter
            };
            
            fetch('/api/aps/workitem', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    appendToLog(`‚ùå ${data.error}`);
                    if (data.details) {
                        appendToLog(`   Details: ${JSON.stringify(data.details, null, 2)}`);
                    }
                }
                // Success messages will come through Socket.IO
            })
            .catch(error => {
                appendToLog(`‚ùå Network error: ${error.message}`);
            });
        });
        document.getElementById('btnDownloadJson').addEventListener('click', () => {
            const serverUrl = getServerUrl();
            
            // Clear log and show what we're doing
            appendToLog('üîÑ Generating download URL for result.json...');
            
            // Get the signed download URL from our API
            fetch(`${serverUrl}/api/aps/download/result-json`)
                .then(response => response.json())
                .then(data => {
                    appendToLog(`--- RESPONSE (Status: 200) ---`);
                    appendToLog(`<pre>${JSON.stringify(data, null, 2)}</pre>`);
                    
                    if (data.downloadUrl) {
                        // Show the actual URL in the log
                        appendToLog(`<strong>üì• Download URL Generated:</strong>`);
                        appendToLog(`<a href="${data.downloadUrl}" target="_blank" download="${data.fileName}">üîó ${data.downloadUrl}</a>`);
                        
                        // For result.json, also fetch and display the Dynamo outputs
                        appendToLog(`<br/>üîç Fetching JSON content to display Dynamo results...`);
                        
                        fetch(data.downloadUrl)
                            .then(resultResponse => resultResponse.json())
                            .then(resultData => {
                                displayDynamoOutputs(resultData);
                                
                                // Now trigger the actual download
                                const link = document.createElement('a');
                                link.href = data.downloadUrl;
                                link.download = data.fileName;
                                link.style.display = 'none';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                
                                appendToLog(`‚úÖ ${data.fileName} download started!`);
                            })
                            .catch(err => {
                                appendToLog(`‚ö†Ô∏è Could not parse result.json for display: ${err.message}`);
                                
                                // Still trigger download even if parsing failed
                                const link = document.createElement('a');
                                link.href = data.downloadUrl;
                                link.download = data.fileName;
                                link.style.display = 'none';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                
                                appendToLog(`‚úÖ ${data.fileName} download started!`);
                            });
                    } else {
                        appendToLog('‚ùå No download URL received');
                    }
                })
                .catch(error => {
                    appendToLog(`‚ùå Error: ${error.message}`);
                });
        });
        document.getElementById('btnDownloadRvt').addEventListener('click', () => {
            const serverUrl = getServerUrl();
            
            // Clear log and show what we're doing
            appendToLog('üîÑ Generating download URL for result.rvt...');
            
            // Get the signed download URL from our API
            fetch(`${serverUrl}/api/aps/download/result-rvt`)
                .then(response => response.json())
                .then(data => {
                    appendToLog(`--- RESPONSE (Status: 200) ---`);
                    appendToLog(`<pre>${JSON.stringify(data, null, 2)}</pre>`);
                    
                    if (data.downloadUrl) {
                        // Show the actual URL in the log
                        appendToLog(`<strong>üì• Download URL Generated:</strong>`);
                        appendToLog(`<a href="${data.downloadUrl}" target="_blank" download="${data.fileName}">üîó ${data.downloadUrl}</a>`);
                        
                        // Create temporary link element and trigger download
                        const link = document.createElement('a');
                        link.href = data.downloadUrl;
                        link.download = data.fileName;
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        appendToLog(`‚úÖ ${data.fileName} download started!`);
                        appendToLog(`<br/>üéØ <strong>This is your processed Revit file with Dynamo changes applied!</strong>`);
                    } else {
                        appendToLog('‚ùå No download URL received');
                    }
                })
                .catch(error => {
                    appendToLog(`‚ùå Error: ${error.message}`);
                });
        });

        // File upload handlers - Updated to match reference API paths and include Socket.IO
        document.getElementById('btnUploadAppBundle').addEventListener('click', () => {
            const fileInput = document.getElementById('appBundleFile');
            if (!fileInput.files[0]) {
                appendToLog('‚ùå Please select the DynamoRevitDA.zip file first');
                return;
            }
            if (!socketId) {
                appendToLog('‚ùå Not connected to server. Please refresh the page.');
                return;
            }
            const formData = new FormData();
            formData.append('appBundleFile', fileInput.files[0]);
            formData.append('socketId', socketId);
            makeApiCall('/api/aps/appbundle', 'POST', formData);
        });

        document.getElementById('btnUploadPython').addEventListener('click', () => {
            const fileInput = document.getElementById('pythonFile');
            if (!fileInput.files[0]) {
                appendToLog('‚ùå Please select the pythonDependencies.zip file first');
                return;
            }
            if (!socketId) {
                appendToLog('‚ùå Not connected to server. Please refresh the page.');
                return;
            }
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('fileType', 'python');
            formData.append('socketId', socketId);
            makeApiCall('/api/aps/upload/single', 'POST', formData);
        });

        document.getElementById('btnUploadRvt').addEventListener('click', () => {
            const fileInput = document.getElementById('rvtFile');
            if (!fileInput.files[0]) {
                appendToLog('‚ùå Please select a Revit (.rvt) file first');
                return;
            }
            if (!socketId) {
                appendToLog('‚ùå Not connected to server. Please refresh the page.');
                return;
            }
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('fileType', 'rvt');
            formData.append('socketId', socketId);
            makeApiCall('/api/aps/upload/single', 'POST', formData);
        });

        document.getElementById('btnUploadDyn').addEventListener('click', () => {
            const fileInput = document.getElementById('dynFile');
            if (!fileInput.files[0]) {
                appendToLog('‚ùå Please select a Dynamo (.dyn) file first');
                return;
            }
            if (!socketId) {
                appendToLog('‚ùå Not connected to server. Please refresh the page.');
                return;
            }
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('fileType', 'dynamo');
            formData.append('socketId', socketId);
            makeApiCall('/api/aps/upload/single', 'POST', formData);
        });

        document.getElementById('btnUploadPackages').addEventListener('click', () => {
            const fileInput = document.getElementById('packagesFile');
            if (!fileInput.files[0]) {
                appendToLog('‚ùå Please select a packages.zip file first');
                return;
            }
            if (!socketId) {
                appendToLog('‚ùå Not connected to server. Please refresh the page.');
                return;
            }
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('fileType', 'packages');
            formData.append('socketId', socketId);
            makeApiCall('/api/aps/upload/single', 'POST', formData);
        });

        // Initialize
        appendToLog('üöÄ Design Automation for Dynamo - Ready!');
        appendToLog('üí° Click "üìÑ See Code" buttons to view the implementation');
    </script>
</body>

</html> 